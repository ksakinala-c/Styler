var VideoView=VideoView||{};!function(e){VideoView=Backbone.View.extend({el:"#video-pane-container",events:{"click #retry_video":"retryVideoCapture","click #video-record-save":"saveCapturedVideo","click .remove-video":"removeVideoHandler","click #video-upload-cancel":"videoChoose","click #video-record-cancel":"videoChoose","click #cancel_video":"videoChoose","click #video-terms-checkbox":function(t){"checked"!==e(t.currentTarget).attr("checked")?this.disableLinks():this.enableLinks()},"click .video-capture-link":function(e){"checked"!==this.$("#video-terms-checkbox").attr("checked")?e.preventDefault():this.toggle_video_view("video-capture")},"click .video-upload-link":function(e){"checked"!==this.$("#video-terms-checkbox").attr("checked")?e.preventDefault():this.toggle_video_view("video-upload")}},initialize:function(t){Backbone.View.prototype.initialize.apply(this,arguments),this.viewModel=t.viewModel,this.faceplate=t.faceplate,this.listenToOnce(this.viewModel,"change:is_editing",this.cartEditToggle),this.listenTo(this.viewModel,"change:display_type",this.setVideoTypeIdInput),this.listenTo(this.faceplate,"change:video_name",this.videoNameDisplay),this.$uploadLink=this.$(".video-upload-link"),this.$captureLink=this.$(".video-capture-link");var i=this;i.upload_file_size_limit=50,i.swfu,i.flashvars={camImageWidth:"320",camImageHeight:"240",camImageX:"0",camImageY:"0",recordedVideoWidth:"640",recordedVideoHeight:"480",recordedVideoFPS:"30",lowestBWSetting:"500",highestBWSetting:"1000",lowBandwidthQuality:"40",mediumBandwidthQuality:"50",highBandwidthQuality:"70",recordTimeAllowed:"30",usrMsgContainerX:"1",usrMsgContainerY:"221",usrMsgCamRequired:gettext("A camera is required."),usrMsgMicRequired:gettext("No microphone detected."),usrMsgNoConnection:gettext("Unable to connect to the server."),interfaceStartRec:"/static/img/video/start_recording.png",interfaceStopRec:"/static/img/video/stop_recording.png",interfaceReRec:"/static/img/video/rerecord_video.png",interfacePlayRec:"/static/img/video/play_recording.png",interfaceStopPlay:"/static/img/video/stop_playback.png",interfaceRecordX:"40",interfaceRecordY:"246",interfacePlayX:"150",interfacePlayY:"246",interfaceTimerX:"8",interfaceTimerY:"245"},i.params={menu:"false",allowfullscreen:"false",allowscriptaccess:"always",wmode:"transparent"},i.attributes={id:"VideoRecorder",name:"VideoRecorder"},i.allowedVideoExtensions=["mov","m4v","avi","wmv"],i.videoData="","undefined"!=typeof swfobject&&swfobject.embedSWF("/static/flash/VideoRecorder.swf","videoContainer","320","274","10.0.2","/static/flash/expressInstall.swf",i.flashvars,i.params,i.attributes),sendClientId=function(t){e("#captured-flv").val(t+".flv")},sendVideoLength=function(t){e("#video-length").val(t)},sendBandwidth=function(t){e("#bandwidth").val(t)},sendRecordQuality=function(t){e("#quality").val(t)},"undefined"!=typeof jsonData&&jsonData.s3_info&&(i.today=new Date,i.swfu=new SWFUpload({upload_url:"https://"+jsonData.s3_info.bucket+".s3.amazonaws.com/",flash_url:jsonData.static_url+"flash/swfupload.swf",file_size_limit:i.upload_file_size_limit+" MB",post_params:{key:"s3_upload_test/"+(i.today.getMonth()+1)+"/"+i.today.getDate()+"/"+i.randomID()+"_${filename}",AWSAccessKeyId:jsonData.s3_info.aws_access_key,acl:"private",policy:jsonData.s3_info.policy,signature:jsonData.s3_info.signature,success_action_status:"201"},button_placeholder_id:"uploaderContainer",button_width:"50px",button_height:"15px",button_text:'<span class="flash-button">Upload</span>',button_text_style:".flash-button  {position:relative; top:3px; cursor:pointer; display:block; font-size:13px; font-weight:bold; color: #ffffff; font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;}",button_text_left_padding:0,button_text_top_padding:0,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,file_post_name:"file",http_success:[201,202],upload_progress_handler:uploadProgress,upload_success_handler:uploadSuccess})),e("#video_iframe").load(function(){var t=e("#video_iframe").contents(),o=t.find("#noflash_upload_form").data("prev-file-name");if(e("#video_file",t).click(function(){var t,i=e("#video-upload-title",parent.document).val();return i.length<1?t=gettext("Please enter a video title."):i.length>20?t=gettext("Title must be 20 or fewer characters"):-1==i.search(/^[\w ]{1,20}$/)&&(t=gettext("Title must only be made of letters, digits, and spaces.")),t?(show_jgrowl_message(t,"error",!1),!1):void 0}),e("#video-upload-cancel",t).click(function(){i.toggle_video_view("video-choose")}),e("#video_file",t).change(function(){var o=e(this)[0],a=o.value;if(o.files&&(videoFile=e(this)[0].files[0],videoFile.size>1024*i.upload_file_size_limit*1024))return message=gettext("Video files must be less than "+i.upload_file_size_limit+" MB."),void top.show_jgrowl_message(message,"error",!1);if(allowedString=i.allowedVideoExtensions.join(", "),!i.isAllowedExtension(a)){var d=gettext("Video files must be of the following types: ")+allowedString;return void show_jgrowl_message(d,"error",!1)}e("#video-upload-spinner",parent.document).css("visibility","visible"),e("#video_s3_form",t).submit(),e("#video-upload-button").attr("disabled","disabled").addClass("disabled")}),o){try{var a=e("#video-upload-title").val();e("#video-upload-spinner").css("visibility","hidden"),i.uploadVideo(o,a)}catch(d){var s=gettext("An error occurred uploading your video. Please try again.");top.show_jgrowl_message(s,"error",!1)}t.contents().find("#video-upload-cancel").hide()}}),this.disableLinks(),this.videoTermsOverlay()},videoTermsOverlay:function(){this.$("a.video-terms-link").overlay({mask:"#ccc"})},videoChoose:function(){this.toggle_video_view("video-choose")},cartEditToggle:function(){if(this.viewModel.get("is_editing")&&"VIDEO"===this.viewModel.get("display_type")){var t=e("#cart").find(".cart-item.cart-item-edit").find("img"),i=e('input[name="video_capture"]').val(),o={video_name:t.data("video-name"),video_token:t.data("video-token"),video_id:t.data("video-id"),video_type:i?"C":"U"};this._setModel(o),this.toggle_video_view("video-display")}},toggle_video_view:function(t,i){var o=i||300;e("#"+t).fadeIn(o).siblings().hide()},enableLinks:function(){this.$uploadLink.prop("disabled",!1).removeClass("disabled"),this.$captureLink.prop("disabled",!1).removeClass("disabled")},disableLinks:function(){this.$uploadLink.prop("disabled",!0).addClass("disabled"),this.$captureLink.prop("disabled",!0).addClass("disabled")},getVideoData:function(t,i){return e.ajax({url:t,type:"POST",dataType:"JSON",cache:!1,data:i})},removeVideoHandler:function(e){e.preventDefault();var t=this,i=this.faceplate.get("video_token"),o="/video/remove/"+i+"/",a=gettext("Your video was successfully removed.");i&&t.getVideoData(o).done(function(e){e.error_message?show_jgrowl_message(e.error_message,"error",!0):e.success&&show_jgrowl_message(a,"success",!1)}),t._resetModel(),t.toggle_video_view("video-choose")},saveCapturedVideo:function(){this.validateCapturedForm()&&this.submitCapturedForm()},getCapturedFormValues:function(){var t={captured_flv:e("#captured-flv").val(),alias_name:e("#video-record-title").val(),quality:e("#quality").val(),bandwidth:e("#bandwidth").val(),video_length:e("#video-length").val()};return t},validateCapturedForm:function(t){var i=this.getCapturedFormValues(),o=gettext("Please enter a Video Title."),a=gettext("Please retry your upload."),d=!0;return""===i.alias_name?(show_jgrowl_message(o,"error",!0),e("#video-record-title").focus(),d=!1):(""===i.captured_flv||""===i.video_length||i.video_length<1)&&(show_jgrowl_message(a,"error",!0),d=!1),d},submitCapturedForm:function(){var e,t=this,i="/video/capture/",o=t.getCapturedFormValues();return t.getVideoData(i,o).done(function(e){t.getFlashMovieObject("VideoRecorder").submitVideo(),t.displayFinishedVideo(e)}).fail(function(t,i,o){e=JSON.parse(t.responseText),show_jgrowl_message(_.values(e.errors),"error",!0)}),!1},displayFinishedVideo:function(e){this._setModel(e),this.setVideoTypeIdInput(),this.toggle_video_view("video-display")},retryVideoCapture:function(t){t.preventDefault(),e("#video-capture").empty().html(e("#video-capture").html()),this.toggle_video_view("video-capture")},setVideoTypeIdInput:function(){var t=e('input[name="video_capture"]'),i=e('input[name="video_upload"]'),o=this.faceplate.get("video_type"),a=this.faceplate.get("video_id");"VIDEO"===this.viewModel.get("display_type")?"C"===o?t.val(a):"U"===o&&i.val(a):(t.val(""),i.val(""))},videoNameDisplay:function(){this.$(".video-display-title-js").html(this.faceplate.get("video_name"))},getFlashMovieObject:function(e){return window.document[e]?window.document[e]:-1!=navigator.appName.indexOf("Microsoft Internet")?document.getElementById(e):document.embeds&&document.embeds[e]?document.embeds[e]:void 0},_randomChunk:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},randomID:function(){return _randomChunk()+_randomChunk()+_randomChunk()+_randomChunk()},uploadProgress:function(t,i,o){var a=(i/o*100).toFixed(2);e("#temp-progress").html(a)},uploadSuccess:function(e,t,i){var o=new DOMParser,a=o.parseFromString(t,"text/xml"),d=a.getElementsByTagName("Location")[0].firstChild.nodeValue,s=self.$('input[name="video-upload-title"]').val();self.uploadVideo(d,s)},uploadVideo:function(e,t){var i=this,o="/video/upload/",a=encodeURI(e),d={location:a,alias_name:t};i.getVideoData(o,d).done(function(e){e.success?(i.$('input[name="video-upload-title"]').val(""),i.displayFinishedVideo(e)):show_jgrowl_message(e.error_message,"error",!0)})},isAllowedExtension:function(e){var t=-1!==e.indexOf(".")?e.replace(/.*[.]/,"").toLowerCase():"",i=this.allowedVideoExtensions;if(!i.length)return!0;for(var o=0;o<i.length;o++)if(i[o].toLowerCase()==t)return!0;return!1},_setModel:function(e){this.faceplate.set("video_id",e.video_id),this.faceplate.set("video_name",e.video_name),this.faceplate.set("video_token",e.video_token),this.faceplate.set("video_type",e.video_type)},_resetModel:function(){this.faceplate.set("video_id",""),this.faceplate.set("video_name",""),this.faceplate.set("video_token",""),this.faceplate.set("video_type","")}})}(jQuery);