!function(e){window.Cart=Backbone.Model.extend({urlRoot:"/cart/api/v1/cart/",items:function(){var e=this.get("items");return new CartItems(e)},initialize:function(){_.bindAll(this,"items")},url:function(){var e=Backbone.Model.prototype.url.call(this);return e+("/"==e.charAt(e.length-1)?"":"/")}}),window.CartItem=Backbone.Model.extend({}),window.CartItems=Backbone.Collection.extend({model:CartItem}),window.CartItemView=Backbone.View.extend({initialize:function(){this.template=_.template(e("#cart-item-template").html())},render:function(){var e=this.template(this.model.toJSON());return this.$el.html(e),this}}),window.CartView=Backbone.View.extend({className:"cart",el:"#cart",initialize:function(){this.listenTo(this.model,"change",this.render)},events:{"click .cart-action-remove":"removeItem","click .cart-action-save":"saveItem","click .cart-accessory-remove":"removeItemAccessory"},saveItem:function(t){t.preventDefault(),e("#save-item").click()},removeItemAccessory:function(t){t.preventDefault();var o=e(t.currentTarget).data("accessoryCode"),r=e(t.currentTarget).data("cartToken"),a="/cart/item/"+r+"/remove_accessory/"+o+"/",n=this;e.ajax({url:a,type:"POST",dataType:"json",success:function(t){var o=parseFloat(t.new_total).toFixed(2);e("#cart-total-amount").text(o),n.model.fetch()}})},removeItem:function(t){e(t.target).overlay({mask:"#ccc",onLoad:function(t){var o=this,r=this.getTrigger(),a=r.data("remove-url"),n=r.closest(".cart-item"),i=r.data("redirect-url"),c='<div class="js-remove-working cart-remove-spinner center"><i class="fa fa-spinner fa-spin fa-4x"></i></div>';e("#remove-item-yes").one("click",function(){n.addClass("cart-item-edit").append(c),e.ajax({url:a,type:"POST",dataType:"json",success:function(e){i.replace(" ","")?window.location.href=i:window.location.reload()},error:function(e,t,o){var r=gettext("Something went wrong. We could not remove this item from your order.");n.removeClass("cart-item-edit").find(".js-remove-working").remove(),show_jgrowl_message(r,"error",!1)}}),o.close()}),e("#remove-item-no").one("click",function(){o.close()})},onClose:function(t){e("#remove-item-no, #remove-item-yes").unbind("click")}}),e(t.target).overlay().load()},render:function(){var t=this.model.get("rendered_cart"),o=this.model;this.$el.html(t),this.$el.trigger("optimizeEvent"),this.promoView=new AddPromoView({el:"#div-promo"}),this.promoView.cart=o,this.promoView.render();var r=e(".cart-item-thumb-button");r.on("mouseover",function(){e(this).parent().find("i").show()}),r.on("mouseleave",function(){e(this).parent().find("i").hide()}),r.each(function(t){e(this).attr("data-cartitemnumber",t);var o=e(this).closest(".cart-item").data("delivery-type");e(this).hoverIntent(hover_config),"PL"!==o&&""!==o&&e(this).overlay({mask:"rgba(204, 204, 204, 0.8)",top:"2%",onBeforeLoad:function(t){this.getOverlay().appendTo("body");var o=this.getOverlay().find("#unboxing-overlay-content"),r=e(t.target).data("cartitemnumber"),a=_.pluck(cartModel.get("groups"),"items")[0][r],n=a.faceplate_code,i=a.from_name,c=a.name,l=a.message,m=a.amount,s=e(t.target).attr("href");s+="?faceplate_code="+n,i&&""!=i&&(s+="&from_name="+encodeURIComponent(i)),c&&""!=c&&(s+="&recipient_name="+encodeURIComponent(c)),l&&""!=l&&(s+="&message="+encodeURIComponent(l)),m&&""!=m&&(s+="&amount="+encodeURIComponent(m)+".00"),o.load(s)},onBeforeClose:function(){e("#unboxing-overlay-content").empty(),e("#exposeMask").remove()}})});var a=this.$el.find(".promo-details");return a.length>0&&this.$el.find(".promo-details").overlay({mask:"#ccc"}),this}}),window.PromoView=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"change",this.render),this.template=_.template(e(this.templateEl).html())},events:{"click .close":"closeOverlay"},closeOverlay:function(t){e("body").find(".promo-details").overlay().close()},render:function(){var e=this.template(this.model.toJSON());this.$el.html(e);var t=this.$el.find(".promo-details");return t.length>0&&this.$el.find(".promo-details").overlay({mask:"#ccc"}),this}}),window.CartPromoBannerView=PromoView.extend({el:"#promo-cart",templateEl:"#promo-cart-template"}),window.TopPromoBannerView=PromoView.extend({el:"#promo-main",templateEl:"#promo-top-template"}),window.PromoOverlayView=PromoView.extend({el:"#overlay-promo",templateEl:"#promo-overlay-template",className:"overlay"}),window.AddPromoView=Backbone.View.extend({className:"promo",events:{"click .add-promo":"updateCart"},initialize:function(){_.bindAll(this,"updateCart")},render:function(){return null!==this.cart.get("promo_errors")&&e("#cart").trigger("promoChangeEvent",[this.cart.get("promo_errors")]),this},updateCart:function(){var e=this.$(".promo-box"),t=e.val();if(null!==t&&""!==t){window.promoCode=t;var o=Backbone.emulateHTTP;Backbone.emulateHTTP=!0,this.cart.save({promo_alias:t},{wait:!0,complete:function(){e.val(""),Backbone.emulateHTTP=o}})}}})}(jQuery);